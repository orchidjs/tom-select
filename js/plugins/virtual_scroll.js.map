{"version":3,"file":"virtual_scroll.js","sources":["../../../src/vanilla.ts","../../../src/plugins/virtual_scroll/plugin.ts"],"sourcesContent":["\n/**\n * Return a dom element from either a dom query string, jQuery object, a dom element or html string\n * https://stackoverflow.com/questions/494143/creating-a-new-dom-element-from-an-html-string-using-built-in-dom-methods-or-pro/35385518#35385518\n *\n * param query should be {}\n */\nexport const getDom = ( query:any ):HTMLElement => {\n\n\tif( query.jquery ){\n\t\treturn query[0];\n\t}\n\n\tif( query instanceof HTMLElement ){\n\t\treturn query;\n\t}\n\n\tif( query.indexOf('<') > -1 ){\n\t\tlet div = document.createElement('div');\n\t\tdiv.innerHTML = query.trim(); // Never return a text node of whitespace as the result\n\t\treturn div.firstChild as HTMLElement;\n\t}\n\n\treturn document.querySelector(query);\n};\n\nexport const escapeQuery = (query:string):string => {\n\treturn query.replace(/['\"\\\\]/g, '\\\\$&');\n}\n\n/**\n * Dispatch an event\n *\n */\nexport const triggerEvent = ( dom_el:HTMLElement, event_name:string ):void => {\n\tvar event = document.createEvent('HTMLEvents');\n\tevent.initEvent(event_name, true, false);\n\tdom_el.dispatchEvent(event)\n};\n\n/**\n * Apply CSS rules to a dom element\n *\n */\nexport const applyCSS = ( dom_el:HTMLElement, css:{ [key: string]: string|number }):void => {\n\tObject.assign(dom_el.style, css);\n}\n\n\n/**\n * Add css classes\n *\n */\nexport const addClasses = ( elmts:HTMLElement|HTMLElement[], ...classes:string[]|string[][] ) => {\n\n\tvar norm_classes \t= classesArray(classes);\n\telmts\t\t\t\t= castAsArray(elmts);\n\n\telmts.map( el => {\n\t\tnorm_classes.map( cls => {\n\t\t\tel.classList.add( cls );\n\t\t});\n\t});\n}\n\n/**\n * Remove css classes\n *\n */\n export const removeClasses = ( elmts:HTMLElement|HTMLElement[], ...classes:string[]|string[][] ) => {\n\n \tvar norm_classes \t= classesArray(classes);\n\telmts\t\t\t\t= castAsArray(elmts);\n\n\telmts.map( el => {\n\t\tnorm_classes.map(cls => {\n\t \t\tel.classList.remove( cls );\n\t\t});\n \t});\n }\n\n\n/**\n * Return arguments\n *\n */\nexport const classesArray = (args:string[]|string[][]):string[] => {\n\tvar classes:string[] = [];\n\tfor( let _classes of args ){\n\t\tif( typeof _classes === 'string' ){\n\t\t\t_classes = _classes.trim().split(/[\\11\\12\\14\\15\\40]/);\n\t\t}\n\t\tif( Array.isArray(_classes) ){\n\t\t\tclasses = classes.concat(_classes);\n\t\t}\n\t}\n\n\treturn classes.filter(Boolean);\n}\n\n\n/**\n * Create an array from arg if it's not already an array\n *\n */\nexport const castAsArray = (arg:any):Array<any> => {\n\tif( !Array.isArray(arg) ){\n \t\targ = [arg];\n \t}\n\treturn arg;\n}\n\n\n/**\n * Get the closest node to the evt.target matching the selector\n * Stops at wrapper\n *\n */\nexport const parentMatch = ( target:null|HTMLElement, selector:string, wrapper?:HTMLElement ):HTMLElement|void => {\n\n\tif( wrapper && !wrapper.contains(target) ){\n\t\treturn;\n\t}\n\n\twhile( target && target.matches ){\n\n\t\tif( target.matches(selector) ){\n\t\t\treturn target;\n\t\t}\n\n\t\ttarget = target.parentNode as HTMLElement;\n\t}\n}\n\n\n/**\n * Get the first or last item from an array\n *\n * > 0 - right (last)\n * <= 0 - left (first)\n *\n */\nexport const getTail = ( list:Array<any>|NodeList, direction:number=0 ):any => {\n\n\tif( direction > 0 ){\n\t\treturn list[list.length-1];\n\t}\n\n\treturn list[0];\n}\n\n/**\n * Return true if an object is empty\n *\n */\nexport const isEmptyObject = (obj:object):boolean => {\n\treturn (Object.keys(obj).length === 0);\n}\n\n\n/**\n * Get the index of an element amongst sibling nodes of the same type\n *\n */\nexport const nodeIndex = ( el:null|Element, amongst?:string ):number => {\n\tif (!el) return -1;\n\n\tamongst = amongst || el.nodeName;\n\n\tvar i = 0;\n\twhile( el = el.previousElementSibling ){\n\n\t\tif( el.matches(amongst) ){\n\t\t\ti++;\n\t\t}\n\t}\n\treturn i;\n}\n\n\n/**\n * Set attributes of an element\n *\n */\nexport const setAttr = (el:Element,attrs:{ [key: string]: null|string|number }) => {\n\tfor( const attr in attrs ){\n\t\tlet val = attrs[attr];\n\t\tif( val == null ){\n\t\t\tel.removeAttribute(attr);\n\t\t}else{\n\t\t\tel.setAttribute(attr, ''+val);\n\t\t}\n\t}\n}\n\n\n/**\n * Replace a node\n */\nexport const replaceNode = ( existing:Node, replacement:Node ) => {\n\tif( existing.parentNode ) existing.parentNode.replaceChild(replacement, existing);\n}\n","/**\n * Plugin: \"restore_on_backspace\" (Tom Select)\n * Copyright (c) contributors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this\n * file except in compliance with the License. You may obtain a copy of the License at:\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under\n * the License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF\n * ANY KIND, either express or implied. See the License for the specific language\n * governing permissions and limitations under the License.\n *\n */\nimport TomSelect from '../../tom-select.js';\nimport { TomOption } from '../../types/index';\nimport { addClasses } from '../../vanilla';\n\n\nTomSelect.define('virtual_scroll',function(this:TomSelect) {\n\tconst self\t\t\t\t\t\t\t= this;\n\tconst orig_canLoad\t\t\t\t\t= self.canLoad;\n\tconst orig_clearActiveOption\t\t= self.clearActiveOption;\n\tconst orig_loadCallback\t\t\t\t= self.loadCallback;\n\n\tvar pagination:{[key:string]:any}\t= {};\n\tvar dropdown_content:HTMLElement;\n\tvar loading_more\t\t\t\t\t= false;\n\n\n\tif( !self.settings.firstUrl ){\n\t\tthrow 'virtual_scroll plugin requires a firstUrl() method';\n\t\treturn;\n\t}\n\n\n\t// in order for virtual scrolling to work,\n\t// options need to be ordered the same way they're returned from the remote data source\n\tself.settings.sortField\t\t\t= [{field:'$order'},{field:'$score'}];\n\n\n\t// can we load more results for given query?\n\tfunction canLoadMore(query:string):boolean{\n\n\t\tif( typeof self.settings.maxOptions === 'number' && dropdown_content.children.length >= self.settings.maxOptions ){\n\t\t\treturn false;\n\t\t}\n\n\t\tif( (query in pagination) && pagination[query] ){\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\n\t// set the next url that will be\n\tself.setNextUrl = function(value:string,next_url:any):void{\n\t\tpagination[value] = next_url;\n\t};\n\n\t// getUrl() to be used in settings.load()\n\tself.getUrl = function(query:string):any{\n\n\t\tif( query in pagination ){\n\t\t\tconst next_url = pagination[query];\n\t\t\tpagination[query] = false;\n\t\t\treturn next_url;\n\t\t}\n\n\t\t// if the user goes back to a previous query\n\t\t// we need to load the first page again\n\t\tpagination = {};\n\n\t\treturn self.settings.firstUrl(query);\n\t};\n\n\t// don't clear the active option (and cause unwanted dropdown scroll)\n\t// while loading more results\n\tself.hook('instead','clearActiveOption',()=>{\n\n\t\tif( loading_more ){\n\t\t\treturn;\n\t\t}\n\n\t\treturn orig_clearActiveOption.call(self);\n\t});\n\n\t// override the canLoad method\n\tself.hook('instead','canLoad',(query:string)=>{\n\n\t\t// first time the query has been seen\n\t\tif( !(query in pagination) ){\n\t\t\treturn orig_canLoad.call(self,query);\n\t\t}\n\n\t\treturn canLoadMore(query);\n\t});\n\n\n\t// wrap the load\n\tself.hook('instead','loadCallback',( options:TomOption[], optgroups:TomOption[])=>{\n\n\t\tif( !loading_more ){\n\t\t\tself.clearOptions();\n\t\t}\n\n\t\torig_loadCallback.call( self, options, optgroups);\n\n\t\tloading_more = false;\n\t});\n\n\n\t// add templates to dropdown\n\t//\tloading_more if we have another url in the queue\n\t//\tno_more_results if we don't have another url in the queue\n\tself.hook('after','refreshOptions',()=>{\n\n\t\tconst query\t\t= self.lastValue;\n\t\tvar option;\n\n\t\tif( canLoadMore(query) ){\n\t\t\toption = self.render('loading_more',{query:query});\n\t\t\tif( option ) option.setAttribute('data-selectable',''); // so that navigating dropdown with [down] keypresses can navigate to this node\n\n\t\t}else if( (query in pagination) && !dropdown_content.querySelector('.no-results') ){\n\t\t\toption = self.render('no_more_results',{query:query});\n\t\t}\n\n\t\tif( option ){\n\t\t\taddClasses(option,self.settings.optionClass);\n\t\t\tdropdown_content.append( option );\n\t\t}\n\n\t});\n\n\n\t// add scroll listener and default templates\n\tself.on('initialize',()=>{\n\t\tdropdown_content = self.dropdown_content;\n\n\t\t// default templates\n\t\tself.settings.render = Object.assign({}, {\n\t\t\tloading_more:function(){\n\t\t\t\treturn `<div class=\"loading-more-results\">Loading more results ... </div>`;\n\t\t\t},\n\t\t\tno_more_results:function(){\n\t\t\t\treturn `<div class=\"no-more-results\">No more results</div>`;\n\t\t\t}\n\t\t},self.settings.render);\n\n\n\t\t// watch dropdown content scroll position\n\t\tdropdown_content.addEventListener('scroll',function(){\n\n\t\t\tconst scroll_percent = dropdown_content.clientHeight / (dropdown_content.scrollHeight - dropdown_content.scrollTop);\n\t\t\tif( scroll_percent < 0.95 ){\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// !important: this will get checked again in load() but we still need to check here otherwise loading_more will be set to true\n\t\t\tif( !canLoadMore(self.lastValue) ){\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// don't call load() too much\n\t\t\tif( loading_more ) return;\n\n\n\t\t\tloading_more = true;\n\t\t\tself.load.call(self,self.lastValue);\n\t\t});\n\t});\n\n});\n"],"names":["addClasses","elmts","classes","norm_classes","classesArray","castAsArray","map","el","cls","classList","add","args","_classes","trim","split","Array","isArray","concat","filter","Boolean","arg","TomSelect","define","self","orig_canLoad","canLoad","orig_clearActiveOption","clearActiveOption","orig_loadCallback","loadCallback","pagination","dropdown_content","loading_more","settings","firstUrl","sortField","field","canLoadMore","query","maxOptions","children","length","setNextUrl","value","next_url","getUrl","hook","call","options","optgroups","clearOptions","lastValue","option","render","setAttribute","querySelector","optionClass","append","on","Object","assign","no_more_results","addEventListener","scroll_percent","clientHeight","scrollHeight","scrollTop","load"],"mappings":"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"}